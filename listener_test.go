package ja4s

import (
	"errors"
	"testing"
)

func TestServerHelloTracker(t *testing.T) {
	cfg := trackerConfig{
		maxBytes: len(sampleServerHello),
		proto:    't',
	}

	tracker := newServerHelloTracker(cfg)

	// Simulate partial writes coming from the TLS stack.
	tracker.Observe(sampleServerHello[:20])
	if _, err := tracker.Result(); !errors.Is(err, ErrUnavailable) {
		t.Fatalf("expected ErrUnavailable for incomplete record, got %v", err)
	}

	tracker.Observe(sampleServerHello[20:])
	got, err := tracker.Result()
	if err != nil {
		t.Fatalf("Result() error = %v", err)
	}

	const want = "t1205h1_c02b_bec8bdbaef8a"
	if got != want {
		t.Fatalf("unexpected JA4S fingerprint, want %q, got %q", want, got)
	}
}

var sampleServerHello = []byte{
	0x16, 0x3, 0x3, 0x0, 0x50, 0x2, 0x0, 0x0, 0x4c, 0x3, 0x3, 0xd1, 0xb6, 0xbc, 0x54,
	0xa8, 0x9e, 0x67, 0xac, 0x3e, 0xd9, 0xb6, 0xb8, 0x26, 0x98, 0x57, 0x62, 0xb4, 0xcc,
	0x6c, 0xdd, 0xe3, 0x9e, 0x4d, 0x7a, 0x95, 0x42, 0x12, 0x32, 0xc7, 0x47, 0xc5, 0x44,
	0x0, 0xc0, 0x2b, 0x0, 0x0, 0x24, 0x0, 0x0, 0x0, 0x0, 0xff, 0x1, 0x0, 0x1, 0x0,
	0x0, 0xb, 0x0, 0x4, 0x3, 0x0, 0x1, 0x2, 0x0, 0x23, 0x0, 0x0, 0x0, 0x10, 0x0,
	0xb, 0x0, 0x9, 0x8, 0x68, 0x74, 0x74, 0x70, 0x2f, 0x31, 0x2e, 0x31,
}
